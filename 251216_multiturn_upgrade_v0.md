# 멀티턴 대화 테스트 설계 전략 v0
## 석사 연구를 위한 재현성·객관성 확보 프로토콜

**작성일**: 2024-12-16  
**목적**: Basic RAG vs Agentic RAG 비교 실험에서 질의 편차를 최소화하고, 컨텍스트 활용 능력을 정량적으로 측정

---

## 1. 설계 원칙 (Design Principles)

### 1.1 핵심 원칙 5가지

1. **질의와 환자 데이터를 분리**
   - 환자 프로필: 정적 JSON (Canonical State)
   - 멀티턴 대화: 턴 타입 규칙에 따라 생성되는 스크립트

2. **각 턴은 고정된 기능(목적)을 가진 타입으로 정의**
   - 정보 수집 / 수치 비교 / 문맥 의존 / 복합 추론 / 정정 / 일관성 검증

3. **정보 공개(슬롯 공개) 스케줄을 고정**
   - "몇 턴에서 어떤 슬롯을 공개할지" 사전 정의
   - Agentic RAG의 맥락 추출/반영 능력을 공정하게 비교

4. **정답(Ground Truth)을 고정하기 어려운 질문은 최소화**
   - "주어진 환자 컨텍스트를 제대로 활용했는지"가 드러나는 질문 중심
   - 진단 단정보다는 "슬롯 반영 여부" 측정

5. **LLM을 사용자 시뮬레이터로 쓸 때는 결정론적 생성**
   - `temperature=0`, `seed` 고정
   - 템플릿+슬롯 채우기만 허용 (자유 생성 금지)

---

## 2. 멀티턴 프로토콜: P6 (6-Turn Protocol)

### 2.1 프로토콜 구조

Basic RAG vs Agentic RAG의 차이가 가장 선명하게 드러나는 6턴 구조:

| Turn | 타입 | 목적 | Agentic 차별점 |
|------|------|------|----------------|
| **T1** | L1: 단순 사실 조회 | 기본 슬롯 정확히 추출 (정확성/환각 억제) | 슬롯 추출 정확도 |
| **T2** | L2: 수치 비교/집계 | 계산 능력 + 컨텍스트 누적 | 다중 문서 통합 |
| **T3** | L3: 문맥 의존 (지시대명사) | 이전 턴 객체 정확히 참조/재사용 | **메모리/컨텍스트 주입** |
| **T4** | L4: 복합 계획/권고 | 검색 기반 추론 + 개인화 계획 | **근거 인용 + 개인화** |
| **T5** | Correction: 정정/모순 | 메모리 업데이트/충돌 해결 | **상태 업데이트 능력** |
| **T6** | Consistency: 반복/회상 | 정정 반영 + 일관성 유지 | **장기 일관성** |

### 2.2 각 턴별 상세 설계

#### T1 (L1: 단순 사실 조회)

**목적**: 환자 기본 정보를 정확히 추출하는지 확인

**템플릿 예시**:
```
"제 기록을 기준으로 다음을 정리해 주세요:
1. 진단명 (있으면 나열, 없으면 '없음')
2. 현재 복용 중인 약물 (약물명, 용량, 빈도 포함. 없으면 '복용약 없음')
3. 알레르기 (있으면 나열, 없으면 '알레르기 없음')

없는 항목은 반드시 '없음'이라고 명시해 주세요."
```

**슬롯 공개**: `diagnosis`, `medications`, `allergy`  
**평가 포인트**: 정확성(GT 일치), 환각 억제(없는 정보 지어내지 않음)

---

#### T2 (L2: 수치 비교/집계)

**목적**: 동일 항목의 시계열 변화를 계산/비교

**코호트별 분기**:
- **Full Cohort** (검사 2회 이상): 
  ```
  "최근 2회 HbA1c 검사 결과 ({date1}: {value1}, {date2}: {value2})를 비교했을 때, 
  수치가 어떻게 변화했습니까? (증가/감소/유지 + 변화량 포함)"
  ```

- **No-Trend Cohort** (검사 1회만):
  ```
  "최근 HbA1c 검사 결과 ({date}: {value})가 목표 범위(7.0% 미만)에 속하는지 
  판단하고 이유를 설명해 주세요."
  ```

**슬롯 공개**: `lab_results` (최근 2개 또는 1개)  
**평가 포인트**: 계산 정확성, 다중 문서 통합

---

#### T3 (L3: 문맥 의존 - 지시대명사 해소)

**목적**: **외부 지식이 아니라** 이전 턴에서 나온 객체를 정확히 참조

**중요**: Gemini 원안의 "약물 부작용/기전" 질문은 **지식베이스 커버리지 차이**가 되므로 제외

**템플릿 예시**:
```
"방금 비교한 그 수치(HbA1c)의 '이전값 / 최근값 / 변화량'을 
한 문장으로 다시 요약해 주세요."
```

또는

```
"아까 정리한 그 약물(첫 번째로 언급된 약)의 
복용 목적과 복용법(용량, 빈도)을 다시 설명해 주세요."
```

**슬롯 공개**: 없음 (이전 턴 재사용)  
**평가 포인트**: **지시대명사 해소 정확도**, 컨텍스트 유지  
**Agentic 핵심**: 메모리/요약/컨텍스트 주입이 제대로 작동하는지

---

#### T4 (L4: 복합 계획/권고 - 근거 인용 강제)

**목적**: 가이드라인 기반 추론 + 개인화된 계획

**템플릿 예시**:
```
"제 나이({age}세), 동반 질환({diagnosis}), 최근 HbA1c({latest_value})를 고려할 때,
'대한당뇨병학회 진료지침' 기준으로 현재 약물 치료를 유지해야 할까요, 
아니면 조정(증량/계열 변경)이 필요할까요?

**반드시 근거 문서에서 찾은 구체적인 기준(예: 목표 HbA1c 범위, 나이별 권고)을 
1~2개 인용하여** 판단 근거를 설명해 주세요."
```

**슬롯 공개**: `age`, `diagnosis`, `latest_lab`  
**평가 포인트**: 근거 인용 정확성, 개인화 반영, 추론 논리  
**공정성 확보**: 양쪽 시스템이 동일한 가이드라인 코퍼스 접근

---

#### T5 (Correction: 정정/모순 투입)

**목적**: 메모리 업데이트/충돌 해결 능력 측정

**템플릿 예시**:
```
"죄송합니다. 아까 HbA1c 최근값이 {old_value}라고 했는데, 
사실 {new_value}였어요. 그렇다면 T4에서 내린 결론(유지 vs 조정)이 
어떻게 바뀌나요?"
```

**슬롯 업데이트**: `lab_results[latest].value` 수정  
**평가 포인트**: 업데이트 반영 속도, 결론 변경의 논리적 일관성  
**Agentic 핵심**: 상태 업데이트 후 재추론

---

#### T6 (Consistency: 반복/회상)

**목적**: 정정 반영 + 전체 컨텍스트 일관성 유지

**템플릿 예시**:
```
"지금까지 제 정보 (나이, 동반질환, 복용약, 정정된 HbA1c 포함)를 
모두 반영해서, 다음 1주일 동안의 행동 계획을 3단계로 정리해 주세요.
(예: 1. 약물 복용, 2. 식이 조절, 3. 재검사 일정)"
```

**슬롯 공개**: 없음 (전체 누적 컨텍스트)  
**평가 포인트**: 정정 반영 여부, 개인화 유지, 계획의 구체성  
**Agentic 핵심**: 장기 일관성 + 컨텍스트 압축

---

## 3. 환자 데이터 설계: "슬롯 기반 시나리오 카드"

### 3.1 환자 JSON 스키마 (Canonical State)

**핵심**: 모든 환자가 동일한 스키마를 가지되, **결측값은 `"없음"` / `"모름"` / `null`로 명시**

```json
{
  "patient_id": "P-1024",
  "name": "김철수",
  "age": 58,
  "gender": "Male",
  "diagnosis": ["Type 2 Diabetes", "Hypertension"],
  "medications": [
    {"name": "Metformin", "dosage": "500mg", "frequency": "BID"},
    {"name": "Amlodipine", "dosage": "5mg", "frequency": "QD"}
  ],
  "allergy": "없음",
  "lab_results": [
    {"date": "2024-01-15", "test": "HbA1c", "value": 7.8},
    {"date": "2024-04-20", "test": "HbA1c", "value": 7.2}
  ],
  "last_visit_note": "환자가 최근 불규칙한 식사로 인해 속쓰림을 호소함.",
  "preferences": "짧고 명확한 설명 선호"
}
```

### 3.2 코호트 분리 전략

**빈 슬롯 문제 해결**: 환자를 3개 코호트로 분리하여 각 코호트별로 질문 프로토콜을 고정

| 코호트 | 조건 | 프로토콜 변형 |
|--------|------|---------------|
| **Full** | `diagnosis`, `medications`, `lab_results` (2회 이상) 모두 있음 | P6 전체 (T1~T6) |
| **No-Meds** | `medications = "없음"` | T1에서 "복용약 없음" 명시, T4는 "약물 없는 환자 기준 권고"로 변형 |
| **No-Trend** | `lab_results` 1회만 | T2를 "비교"가 아니라 "최근값 해석"으로 변형 |

### 3.3 시나리오 난이도 등급

- **L1 (쉬움)**: 모순 없음, 슬롯 1~2개만 중요
- **L2 (중간)**: 슬롯 3~5개 중요 (약물/알레르기 포함)
- **L3 (어려움)**: 모순/정정 턴 포함 + 위험 신호(red flags) 포함

---

## 4. 질문은행(Question Bank) 구조

### 4.1 템플릿 메타데이터

각 템플릿은 다음 필드를 포함:

```python
{
  "template_id": "T1_basic_info",
  "turn_type": "T1",
  "goal": "fact_retrieval",
  "prerequisites": [],  # 필요 슬롯 (없으면 빈 리스트)
  "fallback": null,  # prerequisites 불충족 시 대체 템플릿 ID
  "disclosed_slots": ["diagnosis", "medications", "allergy"],
  "required_slots_in_answer": ["diagnosis", "medications", "allergy"],
  "template_text": "제 기록을 기준으로 진단명, 복용약, 알레르기를 정리해 주세요. 없으면 '없음'이라고 명시해 주세요.",
  "gold_answer_generator": "extract_slots_from_patient"  # 자동 정답 생성 함수명
}
```

### 4.2 Null-Safe 템플릿 설계

**잘못된 예** (빈 슬롯 시 문장 깨짐):
```
"제가 {pmh} 있고 {meds} 복용 중인데..."  
→ pmh=None이면 "제가  있고..."
```

**올바른 예** (분기 템플릿):
```python
if patient["medications"] != "없음":
    template = "제가 {meds} 복용 중인데, 지금 상황에서 조심해야 할 점이 뭐예요?"
else:
    template = "저는 복용약이 없는데, 지금 증상 기준으로 특히 주의할 점이 있을까요?"
```

---

## 5. 환자 응답 프로토콜 (Patient Response Policy)

### 5.1 2-레이어 환자 발화 방식

1. **Canonical Patient State** (정답 상태, JSON)
   - 실험 내부 정답: 슬롯값은 항상 정형 데이터로 유지

2. **Surface Utterance** (표면 발화, 텍스트)
   - 실제 대화에 들어가는 환자 문장
   - Canonical State를 '표현만 바꿔서' 내보내도록 제한

### 5.2 환자 메시지 4블록 구조 (강제)

환자 시뮬레이터(LLM)가 생성하는 메시지는 항상 다음 4블록으로 구성:

```
1. Direct Answer (필수): 방금 질문에 대한 직답 1~2문장
2. Disclosed Slots (규칙 기반): 이번 턴에 공개하기로 한 슬롯만 1~3개
3. Unknown Handling (규칙): 모르면 "모름/기억 안 남/측정 안 함/없음" 중 하나로 표준화
4. Follow-up Question (선택): 프로토콜이 요구할 때만 1문장
```

**예시**:
```
(직답) 네, 열이 있어요.
(슬롯) 체온은 38.2도였고, 어제 저녁부터 시작했어요.
(모름) 혈압은 측정하지 않았어요.
(후속) 이거 응급실 가야 하나요?
```

### 5.3 환자 응답 모드 3종 (선택적 실험)

| 모드 | 설명 | 용도 |
|------|------|------|
| **Cooperative** | 질문에 정확히 답 + 이번 턴 공개 슬롯만 제공 | 기본 실험 |
| **Minimal** | 꼭 묻는 것만 답 (컨텍스트 추출 능력 시험) | Agentic 강점 부각 |
| **Noisy** | 표현 다양 (단, Canonical State는 유지) | 강건성 테스트 |

---

## 6. 평가 루브릭 (Evaluation Rubric)

### 6.1 Gemini 원안의 문제점

- 단일 1~5점 척도 → Judge 변동이 큼
- "추론 논리"가 모호 → 주관 개입 여지

### 6.2 개선된 루브릭: 서브스코어 + 가중합

**4개 항목 서브스코어** (각 0~2점):

1. **Accuracy (정확성)**: GT 값/날짜/수치 오류 개수 기반
   - 2점: 모든 사실 정확
   - 1점: 사소한 오류 1개 (날짜 형식, 단위 등)
   - 0점: 주요 수치/약물명 오류 2개 이상

2. **Context Awareness (문맥 파악)**: 지시대명사 해소 정확도
   - 2점: '그 약/그 수치' 지시 대상 100% 정확
   - 1점: 부분적으로 맞춤 (2개 중 1개)
   - 0점: 지시 대상 오인식 또는 무시

3. **Reasoning Logic (추론 논리)**: 변화량 계산/비교 논리
   - 2점: 계산 정확 + 논리 타당
   - 1점: 계산 맞지만 설명 부족
   - 0점: 계산 오류 또는 논리 비약

4. **Hallucination (환각 억제)**: GT/근거 없는 주장 수
   - 2점: 환각 없음
   - 1점: 사소한 추측 1개 (명시적 표현 포함)
   - 0점: 명백한 허위 정보 2개 이상

**추가 항목** (Agentic RAG 전용):

5. **Evidence Grounding (근거 인용)**: 검색 문서 인용 정확도
   - 2점: 근거 문서 ID + 구체적 문장 인용
   - 1점: 근거 언급했으나 모호
   - 0점: 근거 없음 또는 잘못된 인용

### 6.3 총점 계산 (가중합)

```python
total_score = (
    Accuracy * 0.35 +
    Context * 0.25 +
    Reasoning * 0.25 +
    Hallucination * 0.15
)

# Agentic RAG는 Evidence 추가
total_score_agentic = (
    Accuracy * 0.30 +
    Context * 0.20 +
    Reasoning * 0.20 +
    Hallucination * 0.10 +
    Evidence * 0.20
)
```

### 6.4 LLM-as-a-Judge 프롬프트 (고정)

```markdown
당신은 의료 AI 시스템의 답변 품질을 평가하는 전문가입니다.
제공된 [환자 데이터(Ground Truth)], [질문], [모델의 답변]을 바탕으로 
아래 기준에 따라 각 항목을 0~2점으로 평가하세요.

**평가 기준**:
1. Accuracy (0~2): GT 값/날짜/수치 오류 개수
2. Context (0~2): 지시대명사('그 약', '아까 말한 수치') 해소 정확도
3. Reasoning (0~2): 변화량 계산/비교 논리의 타당성
4. Hallucination (0~2): GT/근거 없는 주장 수 (없으면 2점)
5. Evidence (0~2, Agentic만): 근거 문서 인용 정확도

**출력 형식** (JSON만):
{
  "accuracy": <0~2>,
  "context": <0~2>,
  "reasoning": <0~2>,
  "hallucination": <0~2>,
  "evidence": <0~2>,
  "reason": "<각 항목별 채점 근거 1~2문장>"
}
```

---

## 7. 실험 재현성 체크리스트

### 7.1 필수 고정 요소

- [ ] 환자 시뮬레이터 LLM: `temperature=0`, `seed` 고정
- [ ] 템플릿 선택: 랜덤 금지, `template_id`를 시나리오에 고정
- [ ] 코호트 분류: 환자별로 사전 분류 후 고정
- [ ] 슬롯 공개 스케줄: 턴별로 사전 정의

### 7.2 로깅 필수 항목

각 턴마다 다음을 로그에 저장:

```python
{
  "patient_id": "P-1024",
  "cohort": "Full",
  "scenario_level": "L2",
  "protocol_id": "P6",
  "turn_idx": 3,
  "turn_type": "T3",
  "template_id": "T3_anaphora_resolve",
  "disclosed_slots": [],
  "required_slots": ["lab_results"],
  "canonical_state_snapshot": {...},  # 이번 턴 시점의 환자 상태
  "question": "...",
  "patient_response": "...",
  "model_answer": "...",
  "evaluation": {...}
}
```

### 7.3 공정성 확보

- [ ] 양쪽 시스템(Basic RAG / Agentic RAG)이 동일한 코퍼스 접근
- [ ] "없는 슬롯"은 평가에서 제외 (또는 `"없음"`을 값으로 포함)
- [ ] 대화 길이(턴 수)와 슬롯 공개 수를 동일하게 맞춤

---

## 8. Basic RAG vs Agentic RAG 차별화 포인트

### 8.1 질의 세트 4종 (논문용)

| 세트 | 목적 | 해당 턴 |
|------|------|---------|
| **Context Utilization** | 이전 슬롯 반드시 활용해야 답 가능 | T3, T4, T6 |
| **Correction** | 정정 후 업데이트 반영 | T5 → T6 |
| **Under-specification** | 정보 부족 시 필수 질문 유도 | T1 (선택적) |
| **Consistency** | 유사 질문 반복 시 일관성 | T6 변형 |

### 8.2 Agentic RAG가 우세할 것으로 예상되는 지표

- **T3 (Context)**: 지시대명사 해소 정확도 ↑
- **T4 (Evidence)**: 근거 인용 정확도 ↑
- **T5 → T6 (Consistency)**: 정정 반영 속도 ↑
- **전체 (Hallucination)**: 환각 억제 ↑

---

## 9. 구현 로드맵

### Phase 1: 데이터 준비
1. 환자 시나리오 카드 20개 생성 (코호트별 균등 분배)
2. 질문은행 템플릿 40~60개 작성 (턴별 5~10개)
3. Gold Answer 자동 생성 함수 구현 (T1, T2, T3)

### Phase 2: 시뮬레이터 구축
1. 환자 응답 생성기 (4블록 구조 강제)
2. 템플릿 선택 로직 (prerequisites + fallback)
3. 대화 로거 (턴별 상태 스냅샷)

### Phase 3: 평가 파이프라인
1. LLM-as-a-Judge 프롬프트 고정
2. 서브스코어 자동 계산
3. 결과 시각화 (턴별/코호트별 비교)

### Phase 4: 실험 실행
1. Basic RAG vs Agentic RAG 각 20개 시나리오 × P6 = 240턴
2. 3회 반복 실험 (seed 변경)
3. 통계 분석 (t-test, effect size)

---

## 10. 예상 결과 및 논문 기여

### 10.1 재현성 확보 방법 (논문 방어 포인트)

> "질문의 자의성을 배제하고 시스템의 추론 능력만을 독립적으로 평가하기 위해,
> **턴 타입별 고정 프로토콜(P6)**과 **슬롯 기반 템플릿 은행**을 사용했습니다.
> 환자 데이터는 결측값을 명시적으로 처리하여 모든 실험에서 동일한 난이도를 유지했으며,
> 평가는 서브스코어 기반 루브릭으로 객관성을 확보했습니다."

### 10.2 기대 효과

- **재현성**: 동일 코드/데이터로 실험 반복 가능
- **객관성**: 평가 편차 최소화 (서브스코어 + 가중합)
- **차별성**: Agentic RAG의 강점(컨텍스트/메모리/근거)을 정량화

---

## 11. 참고 문헌 및 관련 작업

- ChatGPT 대화 로그: 2024-12-16
- Gemini 대화 로그: 2024-12-16
- 기존 멀티턴 테스트 결과: `experiments/` (이전 편차 문제 분석)

---

**구현 완료**: 
1. ✅ 환자 시나리오 생성기: `experiments/multiturn/patient_scenarios.py`
2. ✅ 질문은행 (16개 템플릿): `experiments/multiturn/question_bank.py`
3. ✅ 멀티턴 시뮬레이터: `experiments/multiturn/multiturn_simulator.py`
4. ✅ 평가 루브릭: `experiments/multiturn/evaluation_rubric.py`
5. ✅ 실험 러너: `experiments/multiturn/run_multiturn_experiment.py`
6. ✅ 빠른 테스트: `experiments/multiturn/quick_test.py` (통과 확인)

**실행 방법**:
```bash
# 빠른 테스트 (전체 파이프라인 검증)
python experiments/multiturn/quick_test.py

# 전체 실험 실행 (실제 RAG 시스템 연결 필요)
python experiments/multiturn/run_multiturn_experiment.py --num-scenarios 13
```

**다음 단계**: 
1. `run_multiturn_experiment.py`의 `_call_basic_rag()` / `_call_agentic_rag()` 함수에 실제 RAG 시스템 연결
2. 전체 실험 실행 및 결과 분석
3. 논문 작성 (방법론/결과 섹션)

---

**작성자 노트**:
- 이 전략은 석사 논문의 재현성/객관성 요구사항을 충족하도록 설계되었습니다.
- 실제 구현 시 코호트 분리와 템플릿 게이팅이 핵심입니다.
- 평가 루브릭의 서브스코어는 통계 분석에 유리합니다 (항목별 t-test 가능).

